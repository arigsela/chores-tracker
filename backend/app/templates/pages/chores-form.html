<div class="bg-white p-6 rounded-lg shadow-md">
    <h2 class="text-2xl font-bold mb-4">Add New Chore</h2>
    
    <form id="chore-form" hx-post="/api/v1/chores/" hx-swap="outerHTML">
        <div class="mb-4">
            <label class="block text-gray-700 mb-2" for="title">Title</label>
            <input class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" 
                   type="text" id="title" name="title" required>
        </div>
        
        <div class="mb-4">
            <label class="block text-gray-700 mb-2" for="description">Description</label>
            <textarea class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" 
                      id="description" name="description" rows="3"></textarea>
        </div>
        
        <div class="mb-4">
            <label class="flex items-center mb-2">
                <input type="checkbox" id="is_range_reward" name="is_range_reward" class="mr-2">
                <span class="text-gray-700">Range-based reward</span>
            </label>
            
            <div id="fixed-reward-container">
                <label class="block text-gray-700 mb-2" for="reward">Fixed Reward ($)</label>
                <input class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" 
                       type="number" id="reward" name="reward" step="0.01" min="0" required>
            </div>
            
            <div id="range-reward-container" class="hidden space-y-2">
                <div>
                    <label class="block text-gray-700 mb-2" for="min_reward">Minimum Reward ($)</label>
                    <input class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" 
                           type="number" id="min_reward" name="min_reward" step="0.01" min="0">
                </div>
                <div>
                    <label class="block text-gray-700 mb-2" for="max_reward">Maximum Reward ($)</label>
                    <input class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" 
                           type="number" id="max_reward" name="max_reward" step="0.01" min="0">
                </div>
            </div>
        </div>
        
        <div class="mb-4">
            <label class="block text-gray-700 mb-2" for="cooldown_days">Days Before Can Complete Again</label>
            <input class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" 
                   type="number" id="cooldown_days" name="cooldown_days" min="0" value="0">
            <p class="text-sm text-gray-500 mt-1">Set to 0 for immediate completion, 1 for daily, 7 for weekly, etc.</p>
        </div>
        
        <div class="mb-4">
            <label class="block text-gray-700 mb-2" for="assignee_id">Assign To</label>
            <div id="children-dropdown-container">
                <select class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" 
                        id="assignee_id" name="assignee_id" required>
                    <option value="">Loading children...</option>
                </select>
            </div>
        </div>
        
        <div class="mb-6">
            <label class="flex items-center">
                <input type="checkbox" id="is_recurring" name="is_recurring" class="mr-2">
                <span class="text-gray-700">Recurring Chore</span>
            </label>
            
            <div id="frequency-container" class="mt-2 hidden">
                <label class="block text-gray-700 mb-2" for="frequency">Frequency</label>
                <select class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" 
                        id="frequency" name="frequency">
                    <option value="daily">Daily</option>
                    <option value="weekly">Weekly</option>
                    <option value="monthly">Monthly</option>
                </select>
                <p class="text-sm text-gray-500 mt-1">Note: Use the Days Before Can Complete Again field above for more control.</p>
            </div>
        </div>
        
        <div class="flex justify-end space-x-2">
            <button type="button" 
                    class="px-4 py-2 bg-gray-300 text-gray-700 rounded-md hover:bg-gray-400"
                    onclick="document.getElementById('main-content').innerHTML = ''">
                Cancel
            </button>
            <button type="submit" 
                    class="px-4 py-2 bg-blue-500 text-white rounded-md hover:bg-blue-600">
                Save Chore
            </button>
        </div>
    </form>
</div>

<script>
    // Show/hide frequency dropdown based on recurring checkbox
    document.getElementById('is_recurring').addEventListener('change', function() {
        const frequencyContainer = document.getElementById('frequency-container');
        frequencyContainer.classList.toggle('hidden', !this.checked);
        
        // Make frequency required if recurring is checked
        document.getElementById('frequency').required = this.checked;
    });
    
    // Toggle between fixed and range reward
    document.getElementById('is_range_reward').addEventListener('change', function() {
        const fixedRewardContainer = document.getElementById('fixed-reward-container');
        const rangeRewardContainer = document.getElementById('range-reward-container');
        
        fixedRewardContainer.classList.toggle('hidden', this.checked);
        rangeRewardContainer.classList.toggle('hidden', !this.checked);
        
        // Toggle required fields
        document.getElementById('reward').required = !this.checked;
        document.getElementById('min_reward').required = this.checked;
        document.getElementById('max_reward').required = this.checked;
    });
    
    // Function to load children options
    function loadChildrenOptions() {
        const token = localStorage.getItem('token');
        console.log('Token found:', !!token); // Debug log
        
        if (!token) {
            document.getElementById('assignee_id').innerHTML = '<option value="">Please login first</option>';
            return;
        }
        
        // Add a debug message in the dropdown while loading
        document.getElementById('assignee_id').innerHTML = '<option value="">Fetching children...</option>';
        
        fetch('/api/v1/users/children', {
            headers: {
                'Authorization': 'Bearer ' + token
            }
        })
        .then(response => {
            console.log('Response status:', response.status); // Debug log
            if (!response.ok) {
                throw new Error('Failed to fetch children: ' + response.status);
            }
            return response.text();
        })
        .then(html => {
            console.log('HTML received:', html.substring(0, 50) + '...'); // Debug log (first 50 chars)
            document.getElementById('assignee_id').innerHTML = html;
        })
        .catch(error => {
            console.error('Error fetching children:', error);
            document.getElementById('assignee_id').innerHTML = 
                '<option value="">Error loading children. Please try again.</option>';
        });
    }
    
    // Load children immediately
    loadChildrenOptions();
    
    // Also try loading when DOM is fully loaded (backup approach)
    document.addEventListener('DOMContentLoaded', loadChildrenOptions);
    
    // Handle form submission success
    document.addEventListener('htmx:afterRequest', function(event) {
        if (event.detail.target.id === 'chore-form' && event.detail.xhr.status === 201) {
            // Clear form area
            document.getElementById('main-content').innerHTML = '';
            
            // Refresh chores lists
            htmx.trigger('#active-chores', 'load');
        }
    });
</script>